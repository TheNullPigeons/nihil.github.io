# Maintainer: Goultarde
pkgname=netexec
pkgver=1.3.0
pkgrel=1
pkgdesc="The Network Execution tool (successor to CrackMapExec)"
arch=('any')
url="https://github.com/Goultarde/NetExec"
license=('BSD')
depends=('python')
makedepends=('git' 'python-pip' 'rust')
source=("git+https://github.com/Goultarde/NetExec.git")
sha256sums=('SKIP')

package() {
    cd "$srcdir/NetExec"
    
    # 1. Créer le venv dans /opt/pipx/venvs/netexec (Standard pipx global)
    install -d "$pkgdir/opt/pipx/venvs"
    python -m venv "$pkgdir/opt/pipx/venvs/netexec"
    
    # 2. Utiliser le pip du venv pour installer DEPUIS LES SOURCES
    export PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
    "$pkgdir/opt/pipx/venvs/netexec/bin/pip" install .
    
    # 3. Nettoyage
    "$pkgdir/opt/pipx/venvs/netexec/bin/pip" cache purge
    find "$pkgdir/opt/pipx/venvs/netexec" -name "__pycache__" -exec rm -rf {} +
    
    # 4. FIXER LES CHEMINS (Relocation)
    local _pkgdir_escaped=$(echo "$pkgdir" | sed 's/\//\\\//g')
    # On remplace le chemin temporaire de build par rien (car on installe à la racine /)
    # ou plutôt on s'assure que les liens pointent vers /opt/...
    
    # Correction des shebangs dans le dossier bin
    sed -i "s/$_pkgdir_escaped//g" "$pkgdir/opt/pipx/venvs/netexec/bin/"*
    
    # Correction de pyvenv.cfg
    sed -i "s/$_pkgdir_escaped//g" "$pkgdir/opt/pipx/venvs/netexec/pyvenv.cfg"
    
    # 5. Créer les liens symboliques dans /usr/bin comme le ferait pipx ensurepath
    install -d "$pkgdir/usr/bin"
    ln -s "/opt/pipx/venvs/netexec/bin/nxc" "$pkgdir/usr/bin/nxc"
    ln -s "/opt/pipx/venvs/netexec/bin/netexec" "$pkgdir/usr/bin/netexec"
}
