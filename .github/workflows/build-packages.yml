name: Build and Deploy Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Install Arch Linux build tools
      run: |
        sudo apt-get update
        sudo apt-get install -y wget
        wget https://github.com/MarkusJx/arch-makepkg/releases/latest/download/arch-makepkg-x86_64.AppImage
        chmod +x arch-makepkg-x86_64.AppImage
        sudo mv arch-makepkg-x86_64.AppImage /usr/local/bin/arch-makepkg
    
    - name: Build packages from pkgbuilds/
      run: |
        mkdir -p build x86_64
        
        # Build each package found in pkgbuilds/
        for pkgdir in pkgbuilds/*/; do
          if [ -f "$pkgdir/PKGBUILD" ]; then
            pkgname=$(basename "$pkgdir")
            echo "Building package: $pkgname"
            
            # Create build directory
            mkdir -p "build/$pkgname"
            cp "$pkgdir/PKGBUILD" "build/$pkgname/"
            
            # Build package
            cd "build/$pkgname"
            arch-makepkg || {
              echo "Failed to build $pkgname"
              cd ../..
              continue
            }
            
            # Copy to repository
            cp *.pkg.tar.zst ../../x86_64/ 2>/dev/null || true
            cd ../..
          fi
        done
    
    - name: Clean removed packages
      run: |
        cd x86_64
        
        # Get list of current packages from pkgbuilds/
        current_packages=""
        for pkgdir in ../pkgbuilds/*/; do
          if [ -f "$pkgdir/PKGBUILD" ]; then
            pkgname=$(basename "$pkgdir")
            current_packages="$current_packages $pkgname"
          fi
        done
        
        # Find packages to remove from the database
        for pkg in *.pkg.tar.zst; do
          [ -f "$pkg" ] || continue
          
          # Extract package name (remove version and extension)
          pkg_base=$(echo "$pkg" | sed 's/-[0-9].*//')
          
          # Check if package is still in pkgbuilds/
          if ! echo "$current_packages" | grep -q "$pkg_base"; then
            echo "Removing package from repository: $pkg_base"
            
            # Remove from database
            repo-remove nihil.db.tar.gz "$pkg_base"
            
            # Remove package file
            rm -f "$pkg"
          fi
        done
    
    - name: Update repository database
      run: |
        cd x86_64
        
        # Update/create repository database with all current packages
        if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
          # Remove old database if exists
          rm -f nihil.db.tar.gz.old nihil.files.tar.gz.old
          
          # Add all packages (this updates existing entries)
          repo-add nihil.db.tar.gz *.pkg.tar.zst
          
          # Create symlinks
          ln -sf nihil.db.tar.gz nihil.db
          ln -sf nihil.files.tar.gz nihil.files
        else
          echo "No packages found, creating empty repository"
          # Create empty database
          tar czf nihil.db.tar.gz -T /dev/null
          tar czf nihil.files.tar.gz -T /dev/null
          ln -sf nihil.db.tar.gz nihil.db
          ln -sf nihil.files.tar.gz nihil.files
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add x86_64/
        git diff --quiet && git diff --staged --quiet || git commit -m "chore: update packages [skip ci]"
        git push
