name: Build and Deploy Packages

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Build packages using Arch Linux Docker
      run: |
        mkdir -p x86_64
        
        # Build each package found in pkgbuilds/
        for pkgdir in pkgbuilds/*/; do
          if [ -f "$pkgdir/PKGBUILD" ]; then
            pkgname=$(basename "$pkgdir")
            echo "Building package: $pkgname"
            
            # Build using Arch Linux container
            docker run --rm \
              -v "$(pwd)/$pkgdir:/build" \
              -v "$(pwd)/x86_64:/output" \
              archlinux:latest \
              bash -c "
                pacman -Syu --noconfirm base-devel git
                useradd -m builder
                chown -R builder:builder /build /output
                cd /build
                su builder -c 'makepkg -s --noconfirm' || exit 1
                cp *.pkg.tar.zst /output/ 2>/dev/null || true
              " || {
                echo "Failed to build $pkgname"
                continue
              }
          fi
        done
    
    - name: Clean removed packages
      run: |
        cd x86_64
        
        # Skip if no database exists yet
        if [ ! -f "nihil.db.tar.gz" ]; then
          echo "No existing database, skipping cleanup"
          exit 0
        fi
        
        # Get list of current packages from pkgbuilds/
        current_packages=""
        for pkgdir in ../pkgbuilds/*/; do
          if [ -f "$pkgdir/PKGBUILD" ]; then
            pkgname=$(basename "$pkgdir")
            current_packages="$current_packages $pkgname"
          fi
        done
        
        # Find packages to remove from the database
        for pkg in *.pkg.tar.zst 2>/dev/null; do
          [ -f "$pkg" ] || continue
          
          # Extract package name (remove version and extension)
          pkg_base=$(echo "$pkg" | sed 's/-[0-9].*//')
          
          # Check if package is still in pkgbuilds/
          if ! echo "$current_packages" | grep -q "$pkg_base"; then
            echo "Removing package from repository: $pkg_base"
            
            # Install pacman tools
            docker run --rm -v "$(pwd):/repo" archlinux:latest bash -c "
              pacman -Sy --noconfirm pacman
              cd /repo
              repo-remove nihil.db.tar.gz '$pkg_base'
            "
            
            # Remove package file
            rm -f "$pkg"
          fi
        done
    
    - name: Update repository database
      run: |
        cd x86_64
        
        # Update/create repository database with all current packages
        if ls *.pkg.tar.zst 1> /dev/null 2>&1; then
          # Use Arch Linux container to run repo-add
          docker run --rm -v "$(pwd):/repo" archlinux:latest bash -c "
            pacman -Sy --noconfirm pacman
            cd /repo
            rm -f nihil.db.tar.gz.old nihil.files.tar.gz.old
            repo-add nihil.db.tar.gz *.pkg.tar.zst
            ln -sf nihil.db.tar.gz nihil.db
            ln -sf nihil.files.tar.gz nihil.files
          "
        else
          echo "No packages found, creating empty repository"
          tar czf nihil.db.tar.gz -T /dev/null
          tar czf nihil.files.tar.gz -T /dev/null
          ln -sf nihil.db.tar.gz nihil.db
          ln -sf nihil.files.tar.gz nihil.files
        fi
    
    - name: Commit and push changes
      run: |
        git config --local user.email "github-actions[bot]@users.noreply.github.com"
        git config --local user.name "github-actions[bot]"
        
        git add x86_64/
        git diff --quiet && git diff --staged --quiet || git commit -m "chore: update packages [skip ci]"
        git push
